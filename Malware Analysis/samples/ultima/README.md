# Malware Analysis: Ultima

## Introduction
This sample is only for educational purposes, and since it doesn't do any real harm, it's perfect for practicing malware analysis skills. It was developed by [cr-0w](https://github.com/cr-0w). Before the actual analysis, it's wise to go over some terminology. Malware analysis comprises two types of analyses: static and dynamic. Static analysis occurs when you only want to find out about the technicalities of the malware. For example, its hash or the malware family to which it belongs. There are great tools that give a comprehensive first look at malware, one of which is VirusTotal. If you've followed through the [lab setup](https://github.com/mushy2005/Malware-Analysis/tree/main/Malware%20Analysis), you'll notice that Flare has many useful tools for malware analysis built right into it.

## Static Analysis
Before diving into either of the analyses, it's wise to learn about the malware as it seems on the surface. One way to achieve this is by placing the sample into [VirusTotal](https://www.virustotal.com/gui/home/upload). Do note that the sample is a locked zip file with a password. To unzip, simply enter the password: `infected`, or you could even do it straight from Flare, like below:<br> 
<img src="https://github.com/mushy2005/Malware-Analysis/blob/main/Malware%20Analysis/samples/ultima/images/infected.png" width=20% height=20%>
- After unzipping, you'll see these two files:<br><img src="https://github.com/mushy2005/Malware-Analysis/blob/main/Malware%20Analysis/samples/ultima/images/2files.png">
- The only important file is `Ultima.exe.crow`, which is the actual malware. Now, we'll need to find the hashes. We can easily do this by using the `HashMyFiles` application, which comes built-in with FlareVM.<br><img src="https://github.com/mushy2005/Malware-Analysis/blob/main/Malware%20Analysis/samples/ultima/images/hashes.png">
- Since MD5 and SHA-256 are the most common hash functions, we'll only note those values.<br><img src="https://github.com/mushy2005/Malware-Analysis/blob/main/Malware%20Analysis/samples/ultima/images/md5-sha256.png" width="70%" height="70%">
- Now, we can either drop the file into VirusTotal or search it up using the hashes just found out, both ways are perfectly fine. Once the sample has been dropped into VirusTotal, here's what you'll get, as well as the link to report: ![VirusTotal Link](https://www.virustotal.com/gui/file/f48f43594cc5563217a6a19d2af2dc8d82f397a98540fd96c0c5b7d6d6a2a402) <br><img src="https://github.com/mushy2005/Malware-Analysis/blob/main/Malware%20Analysis/samples/ultima/images/VirusTotal.png" width="70%" height="70%">
- As we can see, 35 out of 73 security vendors have flagged this file as malicious. We can also determine the threat category it belongs in, which is `trojan`. Overall, VirusTotal does give a comprehensive overview of the file, however, it shouldn't be the main source of information.
- Now, we'll dive into actual hands-on analysis. Firstly, we need to determine the malware's properties, such as if it is packed or obfuscated, and determine if it's a Portable Executable (PE), as that'll help immensely in our analysis.
- Using our FlareVM setup, we can run an application called `Detect it Easy`, which will give us more information regarding the file's properties. After running it, here's what we get: <br><img src="https://github.com/mushy2005/Malware-Analysis/blob/main/Malware%20Analysis/samples/ultima/images/Detect.png" width="50%" height="50%">
- As you can see, the sample is a 64-bit Portable Executable (PE) file. It seems to target Windows Systems and is compiled using Microsoft Visual C/C++. Another interesting detail is that the file contains a certificate, which indicates an attempt to make it seem more trustworthy. However, the certificate might be invalid.
- To avoid any problems, we should remove the custom extension that the file comes with, which is `.crow`. The reason behind this is that having the extension might mess with the import functions the malware uses. This is how the file will look like once you remove the extension: <br><img src="https://github.com/mushy2005/Malware-Analysis/blob/main/Malware%20Analysis/samples/ultima/images/extension.png">
- Now, I'll be using PE-Bear to determine functions the malware imports, as that'll give us an overall picture of its capabilities. Here's what I got after running PE-Bear: <br><img src="https://github.com/mushy2005/Malware-Analysis/blob/main/Malware%20Analysis/samples/ultima/images/pbr.png" width="60%" height="60%">
- For now, our main focus is looking at the functions in `KERNEL32.dll` because these functions are the essentials for things like memory management and other system-level tasks. Here's all of the functions the malware may access:<br><img src="https://github.com/mushy2005/Malware-Analysis/blob/main/Malware%20Analysis/samples/ultima/images/functions.png"><br><img src="https://github.com/mushy2005/Malware-Analysis/blob/main/Malware%20Analysis/samples/ultima/images/functions2.png">
- As we can see, there are plenty of functions that perform critical tasks such as memory management. For example, functions such as `VirtualAlloc`, which allocates memory for things like memory injection, and `VirtualFree`, which releases said allocated memory.
- There's also `ADVAPI32.dll`, which includes functions related to registry management:<br><img src="https://github.com/mushy2005/Malware-Analysis/blob/main/Malware%20Analysis/samples/ultima/images/functions3.png">
- The functions above all perform registry management actions, which could indicate that the malware is trying to hide manipulate system behavior, and maintain persistence. For example, the `RegCreateKeyExA` function creates a registry key. Malware could use this specific function to, for example, create an "autostart" key that ensures the malware runs every time the system reboots.
- Now, we'll start diving deep into the program internals. Firstly, we'll check for strings, as that might reveal information that could be helpful to our analysis. FlareVM has a `strings` option when you right-click a file's name.<br><img src="https://github.com/mushy2005/Malware-Analysis/blob/main/Malware%20Analysis/samples/ultima/images/str.png">
- After clicking that, we'll get the following interface:<br><img src="https://github.com/mushy2005/Malware-Analysis/blob/main/Malware%20Analysis/samples/ultima/images/strint.png">
- You can also look at the actual text file here: [Ultima Strings](https://github.com/mushy2005/Malware-Analysis/blob/main/Malware%20Analysis/samples/ultima/str_ultima.txt)
- I scanned through the list and found a few strings that stood out to me:<br><img src="https://github.com/mushy2005/Malware-Analysis/blob/main/Malware%20Analysis/samples/ultima/images/str1.png"><br><img src="https://github.com/mushy2005/Malware-Analysis/blob/main/Malware%20Analysis/samples/ultima/images/str2.png"><br><img src="https://github.com/mushy2005/Malware-Analysis/blob/main/Malware%20Analysis/samples/ultima/images/str3.png">
- All of those strings provide a wealth of information. For example, the first set of strings are paths that could be used as an output to whatever the malware is doing. The second set of strings is clearly some kind of credentials because if we look at other strings around that specific area, they serve as clues to what the program is doing, for example, asking for a username and password. Lastly, the third string is the most important one, as it shows signs of bad operations security (OPSEC) by the developer of the malware. Obviously, any "real" malware wouldn't make such mistakes.
- I mentioned that the malware sample had a certificate attached to it, we'll investigate that next. A certificate serves as proof of trustworthiness, essentially saying that your software isn't harmful. That's why certain malware can use certificates to their advantage to seem trustworthy. We can learn more about the certificate for this malware by going to `Properties -> Digital Signatures -> select the signature --> details --> advanced`. This is what it'll look like:<br><img src="https://github.com/mushy2005/Malware-Analysis/blob/main/Malware%20Analysis/samples/ultima/images/cert.png">
- The information above could immensely be helpful in cases of an investigation.

## Dynamic Analysis
- Unlike static analysis, dynamic analysis takes place when you're analyzing the sample while running it, hence the name. Before you run, make sure to take a snapshot to revert back just in case if things go wrong.
- We'll execute it using the command prompt by going into the same directory where our sample is located and running `.\Ultima.exe`. Here's what we get:<br><img src="https://github.com/mushy2005/Malware-Analysis/blob/main/Malware%20Analysis/samples/ultima/images/ultim.png">
- So, we were right about it altering the registry keys. Take note of the following line: `Attempting to read value from Computer\HKEY_CURRENT_USER\Console\VirtualTerminalLevel`. A quick Google search about `VirtualTerminalLevel` will tell us that it's mainly responsible for enhancing the terminal through colors or other features. Therefore, we can conclude that the malware tries to enable ANSI through the aforementioned registry key.
- Since we're only dealing with registry alterations, we'll use a tool known as `Process Monitor (ProcMon)` to observe changes caused by the malware. After filtering for the specific process name and running the malware a second time, here's what we get:<br><img src="https://github.com/mushy2005/Malware-Analysis/blob/main/Malware%20Analysis/samples/ultima/images/procmon.png" width="70%" height="70%">
- And here's terminal:<br><img src="https://github.com/mushy2005/Malware-Analysis/blob/main/Malware%20Analysis/samples/ultima/images/terminal.png">
- As we can see, the color changes, indicating that the registry key `VirtulTerminalLevel` is enabled by the malware. This can also be proved in ProcMon. Also, it asks for credentials, which we had previously stumbled upon when analyzing strings. The username is `gaius` and the password is `glitterychocobo123`. It'll ask us to press a key once the credentials are authorized, which will then give us this:<br><img src="https://github.com/mushy2005/Malware-Analysis/blob/main/Malware%20Analysis/samples/ultima/images/postcred.png">
- After clicking `OK`, we get:<br><img src="https://github.com/mushy2005/Malware-Analysis/blob/main/Malware%20Analysis/samples/ultima/images/postcred2.png">

### Disclaimer
This sample is for educational purposes. Be sure to handle malware samples with caution.
