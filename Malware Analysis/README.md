# Malware Analysis Lab

## Introduction
This guide outlines the steps I took to set up a secure environment for malware analysis.

## Table of Contents
1. [Hardware](#hardware)
2. [Software](#software)
3. [Network Configuration](#network-configuration)
7. [Creating an Undetectable VM with FLAREVM](#creating-an-undetectable-vm-with-flarevm)
   - [Prerequisites](#prerequisites)
   - [Setting Up VMware](#setting-up-vmware)
   - [FlareVM Installation](#flarevm-installation)
   - [Configuration for Undetectability](#configuration-for-undetectability)
   - [Testing](#testing)

## Hardware
- **Specifications** (NOTE: this may change depending on the complexity of the analysis): <br>
Processor: Intel i5-9400F<br>
RAM: 16 GB<br>
Storage: 1.5 TB<br>
GPU: GTX 1660 Ti<br>


## Software
- **Operating System**: Latest version of Windows 11 and/or a Linux distribution (if using REMnux)<br>
- **Malware Analysis Tools**: <br>
  - **Analysis for Potential Functions**: Virus Total
  - **Static Analysis**: Ghidra, IDA Pro
  - **Dynamic Analysis**: Wireshark, Process Monitor
  - **Debugger**: x64dbg
- **Virtualization**: VMware Workstation, VirtualBox
- **Sandboxing**: Any.Run

## Network Configuration
- **Isolation**: Ensuring isolation of the VM is crucial in preventing any potential malware from leaking onto the host.
- **Network Traffic Analysis**: Analyzing the network traffic while executing the malware is an example of Dynamic Analysis, which gives great insight into communications to and from the malware.


## Creating an Undetectable VM with FlareVM
### Prerequisites
- Make sure the following conditions are met before proceeding: <br>
  - The latest version of VMware Workstation (the one I'll be using) or VirtualBox is installed. <br>
  - FlareVM installation: Follow the instructions on [FlareVM](https://github.com/mandiant/flare-vm)<br>
  - Windows 10 ISO: Seek [Windows 10](https://www.microsoft.com/en-us/software-download/windows10) for assistance. 
---
### Setting Up VMware
1. **Install VMware Workstation Pro**:
   - I use Workstation Pro, which you can easily install by following this guide: [VMware Workstation Pro](https://www.mikeroysoft.com/post/download-fusion-ws/)
2. **Create a New Virtual Machine**:
   - Launch VMware and select "Create a New Virtual Machine."
   - Choose ``"Typical (recommended)."``
   - Select ``"I will install the operating system later."`` If we go through with the other installation methods, VMware Tools will be installed, which will interfere with our analysis on the network level.
   - Keep the default specifications (NOTE: FlareVM requires <strong>at least a disk capacity of 60 GB and memory of 2 GB</strong>) and finish the initial configuration.
   - DO NOT start the VM just yet, we have one more step before we launch it.
---
### Configuration for Undetectability
1. **Modifications**
   - **Network Configuration**: Ensure the ``Network Adapter`` is set to ``Host-only``.
   - **VM Identification**: To ensure malware doesn't recognize that it's being executed on a VM, as that'll lead to an improper analysis, perform the following changes:
      - Ensure you're using an SCSI as the Hard Disk instead of NVMe, as, from what I've researched, VMware only lets you spoof the vendor ID when you use an SCSI.
         - If you're using an NVMe, you can easily remove it and add a SCSI by clicking ``Add > Hard Disk > SCSI``.
      - Generate a new MAC address to avoid getting fingerprinted. This can be achieved by going into the ``VM's settings > Network Adapter > Advanced... > Press "Generate" a few times in the MAC Address section``.
      - Once the VM boots up, go through the setup as you normally would. Make sure to disable any of the telemetry features.
NOTE: If you get an error with the code `OOBEKEYBOARD`, follow the steps in this guide to fix the issue: [Error](https://answers.microsoft.com/en-us/windows/forum/all/windows-10-installer-oobe-errors/dede9cbb-a671-4056-b7dd-266f262557da)
   - I used a tool known as `VMware Hardened Loader` that removes common detectable signatures. To install it, follow through the instructions from here: [VMwareHardenedLoader](https://github.com/hzqst/VmwareHardenedLoader)
   - After following all of these steps, proceed to the next section of this guide. 
---
### Best Practices
1. **Snapshots**: Create snapshots during different phases of the installation to revert back in case anything goes wrong.
---
### FlareVM Installation
1. **FlareVM**
   - Do note that FlareVM will be installed <strong>in the actual virtual machine and NOT on the host system</strong>.
   - Go through the installation guide: [FlareVM Github](https://github.com/mandiant/flare-vm).
   - If you have any trouble with disabling Windows Defender, you can download and run <strong>(NOTE: The script will completely erase Defender, meaning you won't be able to have any antivirus, which is recommended for proper malware analysis)</strong> the following script: [Disable Defender](https://github.com/jeremybeaume/tools/blob/master/disable-defender.ps1).
---
### Testing
